name: Build and Test
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  check-formatting:
    name: Check formatting
    runs-on: ubuntu-latest
    container:
      image: matterlabs/llvm_runner:ubuntu22-llvm15-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run fmt
        run: cargo fmt --check
      - name: Run clippy
        run: cargo clippy

  build-and-test:
    strategy:
      matrix:
        include:
          - name: "Linux x86 gnu"
            runner: matterlabs-ci-runner
            target: "x86_64-unknown-linux-gnu"
    runs-on: ${{ matrix.runner }}
    name: ${{ matrix.name }}
    container:
      image: ghcr.io/matter-labs/compilers-ci-ubuntu-22-llvm15:latest
    env:
      UNIT_TESTS_RESULTS_XML: unit-tests-results.xml
      RUSTC_BOOTSTRAP: 1
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
      - name: Prepare environment
        if: "${{ matrix.target }}" != ""
        run: |
          rustup target add ${{ matrix.target }}
      - name: Build
        run: |
          cargo build --release
      - name: Test
        run: |
          cargo install cargo2junit
          cargo test --verbose -- -Z unstable-options --format json | cargo2junit | tee "${UNIT_TESTS_RESULTS_XML}"
      - name: Upload test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          check_name: ${{ matrix.name }} Unit Tests Results
          github_token: ${{ secrets.GITHUB_TOKEN }}
          files: ${{ env.UNIT_TESTS_RESULTS_XML }}
          action_fail_on_inconclusive: true
